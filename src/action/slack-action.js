/**
 * The entry point for the action.
 * @param params Input object
 * "data": {
                    "drink": {
                        "duration": 8,
                        "id": 25,
                        "images": [
                            {
                                "keg_id": 1,
                                "original_url": "https://cdn.theatlantic.com/assets/media/img/mt/2016/01/superman/facebook.jpg",
                                "session_id": 2,
                                "thumbnail_url": "https://cdn.theatlantic.com/assets/media/img/mt/2016/01/superman/facebook.jpg",
                                "time": "2017-02-07T02:07:06.706214+00:00",
                                "url": "https://cdn.theatlantic.com/assets/media/img/mt/2016/01/superman/facebook.jpg",
                                "user_id": "guest"
                            }
                        ],
                        "keg": {
                            "beverage": {
                                "beverage_type": "beer",
                                "color_hex": "#C35900",
                                "id": 1,
                                "name": "Racer 5",
                                "producer": {
                                    "country": "USA",
                                    "description": "",
                                    "id": 1,
                                    "is_homebrew": false,
                                    "name": "Bear Republic",
                                    "origin_city": "",
                                    "origin_state": "",
                                    "url": ""
                                },
                                "style": "IPA"
                            },
                            "end_time": "2017-02-04T02:19:41+00:00",
                            "full_volume_ml": 18927.1,
                            "id": 1,
                            "illustration_thumbnail_url": "http://52.204.245.247:80/static/images/keg/thumb/keg-srm14-3.png",
                            "illustration_url": "http://52.204.245.247:80/static/images/keg/full/keg-srm14-3.png",
                            "keg_type": "corny",
                            "online": true,
                            "percent_full": 85.56519007618225,
                            "remaining_volume_ml": 16195.009090909089,
                            "served_volume_ml": 2732.09090909091,
                            "size": {
                                "id": 0,
                                "name": "corny",
                                "volume_ml": 18927.1
                            },
                            "size_id": 0,
                            "size_name": "corny",
                            "size_volume_ml": 18927.1,
                            "spilled_ml": 0,
                            "spilled_volume_ml": 0,
                            "start_time": "2017-02-04T02:19:41+00:00",
                            "type": {
                                "abv": 0,
                                "brewer_id": "1",
                                "id": "1",
                                "name": "Racer 5",
                                "style_id": "0"
                            },
                            "type_id": "1",
                            "volume_ml_remain": 16195.009090909089
                        },
                        "keg_id": 1,
                        "session": {
                            "end_time": "2017-02-07T05:07:06.701949+00:00",
                            "id": 2,
                            "name": "",
                            "start_time": "2017-02-07T02:02:06+00:00",
                            "url": "/sessions/2017/2/6/2",
                            "volume_ml": 1888
                        },
                        "session_id": 2,
                        "tick_time_series": "0:1 304:6 1946:36 2116:5 2297:4 2505:5 2709:5 2906:2 3120:4 3302:3 3492:1 3694:1 3902:1 8284:0",
                        "ticks": 74,
                        "time": "2017-02-07T02:07:06.701949+00:00",
                        "url": "/drinks/25",
                        "user": {
                            "display_name": "guest",
                            "is_active": true,
                            "url": "/drinkers/guest",
                            "username": "guest"
                        },
                        "user_id": "guest",
                        "volume_ml": 224
                    },
                    "drink_id": 25,
                    "id": 31,
                    "keg": {
                        "beverage": {
                            "beverage_type": "beer",
                            "color_hex": "#C35900",
                            "id": 1,
                            "name": "Racer 5",
                            "producer": {
                                "country": "USA",
                                "description": "",
                                "id": 1,
                                "is_homebrew": false,
                                "name": "Bear Republic",
                                "origin_city": "",
                                "origin_state": "",
                                "url": ""
                            },
                            "style": "IPA"
                        },
                        "end_time": "2017-02-04T02:19:41+00:00",
                        "full_volume_ml": 18927.1,
                        "id": 1,
                        "illustration_thumbnail_url": "http://52.204.245.247:80/static/images/keg/thumb/keg-srm14-3.png",
                        "illustration_url": "http://52.204.245.247:80/static/images/keg/full/keg-srm14-3.png",
                        "keg_type": "corny",
                        "online": true,
                        "percent_full": 85.56519007618225,
                        "remaining_volume_ml": 16195.009090909089,
                        "served_volume_ml": 2732.09090909091,
                        "size": {
                            "id": 0,
                            "name": "corny",
                            "volume_ml": 18927.1
                        },
                        "size_id": 0,
                        "size_name": "corny",
                        "size_volume_ml": 18927.1,
                        "spilled_ml": 0,
                        "spilled_volume_ml": 0,
                        "start_time": "2017-02-04T02:19:41+00:00",
                        "type": {
                            "abv": 0,
                            "brewer_id": "1",
                            "id": "1",
                            "name": "Racer 5",
                            "style_id": "0"
                        },
                        "type_id": "1",
                        "volume_ml_remain": 16195.009090909089
                    },
                    "keg_id": 1,
                    "kind": "drink_poured",
                    "session": {
                        "end_time": "2017-02-07T05:07:06.701949+00:00",
                        "id": 2,
                        "is_active": true,
                        "name": "",
                        "start_time": "2017-02-07T02:02:06+00:00",
                        "url": "/sessions/2017/2/6/2",
                        "volume_ml": 1888
                    },
                    "session_id": 2,
                    "time": "2017-02-07T02:07:06.701949+00:00",
                    "user": {
                        "date_joined": "2017-02-04T02:13:24+00:00",
                        "display_name": "guest",
                        "email": "",
                        "is_active": true,
                        "is_staff": false,
                        "is_superuser": false,
                        "last_login": "2017-02-04T02:13:24+00:00",
                        "url": "/drinkers/guest",
                        "username": "guest"
                    },
                    "user_id": "guest"
                },
 "param1": "https://hooks.slack.com/services/T000000/B00000000/V000000000",
 "type": "event"
 }
 * @returns {Promise}
 */
function main(params) {
    return new Promise(
        (resolve, reject) => {
            //send message to slack channel

            try {
                var IncomingWebhook = require("@slack/client").IncomingWebhook;
            } catch (err) {
                console.log(err);
                reject({
                        "message": "Could not load @slack/client",
                        "error": err.toString()
                    }
                );
            }

            var url = params.slack_webhook_url;

            var webhook = new IncomingWebhook(url);

            console.log(params);

            var volume_oz = Math.round(params.data.drink.volume_ml * 0.033814 * 100 ) / 100;
            var slack_message_text = params.data.drink.user.display_name + " poured " + volume_oz + "oz of " + params.data.drink.keg.beverage.name;
            var images = params.data.drink.images;

            var slack_message = {
                attachments: [
                    {
                        fallback: slack_message_text,
                        color: "#36a64f",
                        pretext: "",
                        text: slack_message_text,
                        "image_url": images !== null && typeof(images) !== "undefined" ? images[0].original_url : params.data.drink.keg.illustration_thumbnail_url,
                        "thumb_url": images !== null && typeof(images) !== "undefined" ? images[0].thumbnail_url : params.data.drink.keg.illustration_thumbnail_url,
                        "footer": "Kegbot API",
                        "footer_icon": "https://platform.slack-edge.com/img/default_application_icon.png"
                    }
                ]
            }

            webhook.send(slack_message,
                function (err, res) {
                    if (err) {
                        console.log('Error:', err);
                        reject(params);
                    } else {
                        console.log('Message sent: ', res);
                        resolve(params);
                    }
                });
        }
    );
}

export default main;